<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель | Проект ВВ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Ваши стили остаются без изменений */
    </style>
</head>
<body>
    <!-- Ваш HTML остаётся без изменений -->

    <script>
        // Глобальные переменные
        const socket = io({
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            transports: ['websocket']
        });
        
        let previousData = {};
        let charts = {};
        let currentFilters = {
            period: 'month',
            dataType: 'all'
        };

        // Обработчики событий WebSocket
        socket.on('connect', () => {
            console.log('Connected to WebSocket');
            document.getElementById('update-time').textContent = 'Соединение установлено';
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from WebSocket');
            document.getElementById('update-time').textContent = 'Соединение потеряно';
        });

        socket.on('connect_error', (error) => {
            console.error('Connection Error:', error);
            document.getElementById('update-time').textContent = 'Ошибка соединения';
            setTimeout(() => socket.connect(), 5000);
        });

        socket.on('data_update', (data) => {
            updateTables(data);
            updateCharts(data);
        });

        // Инициализация графиков (остаётся без изменений)
        function initCharts() {
            // ... ваш код инициализации графиков
        }

        // Обновлённая функция для загрузки данных
        function loadData() {
            const loadingElement = document.getElementById('update-time');
            loadingElement.textContent = 'Загрузка данных...';
            
            currentFilters.period = document.getElementById('timeFilter').value;
            currentFilters.dataType = document.getElementById('dataTypeFilter').value;
            
            fetch(`/admin/data?period=${currentFilters.period}&dataType=${currentFilters.dataType}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!data.leads_by_stage) throw new Error('Invalid data format');
                    updateTables(data);
                    updateCharts(data);
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных:', error);
                    document.getElementById('update-time').textContent = 'Ошибка загрузки данных';
                });
        }

        // Обновлённая функция для обновления таблиц
        function updateTables(data) {
            try {
                if (!data || !data.leads_by_stage) {
                    throw new Error("Invalid data format");
                }

                // Обновляем каждую таблицу
                ['Перезвонить', 'На согласовании', 'Приглашен к рекрутеру'].forEach(stage => {
                    updateStageTable(stage, data.leads_by_stage[stage] || []);
                });
                
                document.getElementById('update-time').textContent = `Обновлено: ${data.timestamp || 'Н/Д'}`;
                document.getElementById('month-info').textContent = `Период: ${data.current_month || 'Н/Д'}`;
                
                previousData = JSON.parse(JSON.stringify(data));
            } catch (error) {
                console.error("Error updating tables:", error);
                document.getElementById('update-time').textContent = 'Ошибка обновления данных';
            }
        }

        // Остальные функции (updateStageTable, updateCharts, exportToPDF, exportToCSV) остаются без изменений

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadData();
            
            document.getElementById('applyFilters').addEventListener('click', loadData);
            document.getElementById('export-pdf').addEventListener('click', exportToPDF);
            document.getElementById('export-csv').addEventListener('click', exportToCSV);
        });
    </script>
</body>
</html>
