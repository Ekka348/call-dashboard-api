<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель | Проект ВВ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ... (прежние стили остаются без изменений) ... */
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.5em;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div>Загрузка данных...</div>
    </div>

    <div class="header">
        <h1>Админ-панель проекта ВВ</h1>
        <div class="header-actions">
            <div class="update-info" id="update-time">Загрузка данных...</div>
            <button class="filter-btn export-btn" id="export-pdf">Экспорт PDF</button>
            <button class="filter-btn export-btn" id="export-csv">Экспорт CSV</button>
        </div>
    </div>
    
    <div class="month-info" id="month-info">Период: загрузка...</div>

    <div class="filters">
        <div class="filter-group">
            <span class="filter-label">Период:</span>
            <select id="timeFilter" class="filter-select">
                <option value="month">Месяц</option>
                <option value="week">Неделя</option>
                <option value="day">День</option>
            </select>
        </div>
        <div class="filter-group">
            <span class="filter-label">Тип данных:</span>
            <select id="dataTypeFilter" class="filter-select">
                <option value="all">Все лиды</option>
                <option value="active">Только активные</option>
            </select>
        </div>
        <button class="filter-btn" id="applyFilters">Применить</button>
    </div>

    <div class="tables-container">
        <!-- Таблицы остаются без изменений -->
    </div>

    <div class="charts-container">
        <!-- Графики остаются без изменений -->
    </div>

    <script>
        // Глобальные переменные
        const socket = io();
        let previousData = {};
        let charts = {};
        let currentFilters = {
            period: 'month',
            dataType: 'all'
        };

        // Показать/скрыть загрузку
        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        // Инициализация графиков
        function initCharts() {
            try {
                // Круговая диаграмма
                charts.stagesChart = new ApexCharts(document.querySelector("#stagesChart"), {
                    series: [],
                    chart: { type: 'donut', height: '100%' },
                    labels: [],
                    colors: ['#3b82f6', '#9333ea', '#10b981', '#f59e0b', '#ef4444'],
                    legend: { position: 'right' }
                });
                charts.stagesChart.render();

                // Остальные графики инициализируются аналогично
                // ...
                
            } catch (error) {
                console.error("Chart initialization error:", error);
            }
        }

        // Обновление таблиц
        function updateTables(data) {
            try {
                if (!data || !data.leads_by_stage) {
                    throw new Error("Invalid data format");
                }

                // Обновляем каждую таблицу
                ['Перезвонить', 'На согласовании', 'Приглашен к рекрутеру'].forEach(stage => {
                    updateStageTable(stage, data.leads_by_stage[stage] || []);
                });
                
                document.getElementById('update-time').textContent = `Обновлено: ${data.timestamp || 'Н/Д'}`;
                document.getElementById('month-info').textContent = `Период: ${data.current_month || 'Н/Д'}`;
                
                previousData = JSON.parse(JSON.stringify(data));
            } catch (error) {
                console.error("Error updating tables:", error);
                document.getElementById('update-time').textContent = 'Ошибка обновления данных';
            }
        }

        function updateStageTable(stageName, leads) {
            const stageId = stageName.replace(/\s+/g, '-').toLowerCase();
            const tbody = document.querySelector(`#${stageId}-table tbody`);
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            let stageTotal = 0;
            
            leads.forEach(item => {
                const row = document.createElement('tr');
                
                const prevLeads = previousData.leads_by_stage?.[stageName] || [];
                const prevItem = prevLeads.find(i => i.operator === item.operator);
                const isChanged = prevItem && prevItem.count !== item.count;
                
                if (isChanged) row.classList.add('highlight');
                if (item.count === 0) row.classList.add('zero-count');
                
                row.innerHTML = `
                    <td>${item.operator || 'Неизвестно'}</td>
                    <td><span class="badge">${item.count || 0}</span></td>
                `;
                
                tbody.appendChild(row);
                stageTotal += item.count || 0;
            });
            
            // Обновляем счетчик в заголовке
            const totalElement = document.getElementById(`${stageId}-total`);
            if (totalElement) {
                totalElement.textContent = stageTotal;
            }
        }

        // Экспорт в PDF
        async function exportToPDF() {
            showLoading(true);
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error("Библиотека jsPDF не загружена");
                }
                
                const pdf = new jsPDF('p', 'pt', 'a4');
                // ... остальной код экспорта ...
                
                pdf.save('отчет_по_лидам.pdf');
            } catch (error) {
                console.error("PDF export error:", error);
                alert("Ошибка при экспорте PDF: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Обработчики событий
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            
            // Загрузка данных
            loadData();
            
            // Обработчики фильтров
            document.getElementById('applyFilters').addEventListener('click', loadData);
            
            // Обработчики экспорта
            document.getElementById('export-pdf').addEventListener('click', exportToPDF);
            document.getElementById('export-csv').addEventListener('click', exportToCSV);
            
            // WebSocket события
            socket.on('data_update', (data) => {
                updateTables(data);
                updateCharts(data);
            });
            
            socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error);
                document.getElementById('update-time').textContent = 'Ошибка соединения с сервером';
            });
        });

        // Загрузка данных
        function loadData() {
            showLoading(true);
            
            currentFilters.period = document.getElementById('timeFilter').value;
            currentFilters.dataType = document.getElementById('dataTypeFilter').value;
            
            fetch(`/admin/data?period=${currentFilters.period}&dataType=${currentFilters.dataType}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateTables(data);
                    updateCharts(data);
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных:', error);
                    document.getElementById('update-time').textContent = 'Ошибка загрузки данных';
                })
                .finally(() => {
                    showLoading(false);
                });
        }
    </script>
</body>
</html>
