<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Leads Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Логин форма -->
  <div class="login-container" id="login-container">
    <div class="login-form">
      <h2>Авторизация</h2>
      <form id="login-form">
        <div class="form-group">
          <label for="username">Логин</label>
          <input type="text" id="username" name="username" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="password">Пароль</label>
          <input type="password" id="password" name="password" required autocomplete="current-password">
        </div>
        <button type="submit" class="login-button" id="login-button">
          <span class="button-text">Войти</span>
          <span class="spinner hidden" id="login-spinner"></span>
        </button>
        <div class="error-message" id="login-error"></div>
      </form>
    </div>
  </div>

  <!-- Основной дашборд -->
  <div class="container" id="dashboard-container">
    <!-- ... (остальная часть вашего HTML остаётся без изменений) ... -->
  </div>

  <!-- Подключаем AuthService -->
  <script src="/static/js/auth.js"></script>
  
  <script>
    // Конфигурация приложения
    const CONFIG = {
      refreshInterval: 300000, // 5 минут
      updateCheckInterval: 60000, // 1 минута
      maxLoginAttempts: 5,
      loginDelay: 30000 // 30 секунд
    };

    // Состояние приложения
    const AppState = {
      currentUser: null,
      isAuthenticated: false,
      isFirstLoad: true,
      dataRefreshInterval: null,
      updateCheckInterval: null,
      historyChart: null,
      historyData: {
        timestamps: [],
        stages: {
          "На согласовании": [],
          "Перезвонить": [],
          "Приглашен к рекрутеру": []
        }
      },
      allOperators: [],
      loginAttempts: 0,
      lastFailedLogin: 0
    };

    // Класс для управления интерфейсом
    class UIManager {
      static initEventListeners() {
        document.getElementById('login-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          await AuthController.handleLogin();
        });
        
        document.getElementById('logout-button').addEventListener('click', AuthController.handleLogout);
        document.getElementById('operator-select').addEventListener('change', UIManager.applyOperatorFilter);
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && AppState.isAuthenticated) {
            AuthController.handleLogout();
          }
        });
      }

      static showLoading(show = true) {
        const button = document.getElementById('login-button');
        const spinner = document.getElementById('login-spinner');
        const buttonText = button.querySelector('.button-text');
        
        button.disabled = show;
        spinner.classList.toggle('hidden', !show);
        buttonText.textContent = show ? 'Вход...' : 'Войти';
      }

      static showLoginError(message) {
        const errorElement = document.getElementById('login-error');
        errorElement.textContent = message;
        setTimeout(() => errorElement.textContent = '', 5000);
      }

      static showLogin() {
        clearIntervals();
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('dashboard-container').style.display = 'none';
        document.getElementById('login-error').textContent = '';
        document.getElementById('password').value = '';
        AppState.currentUser = null;
        AppState.isAuthenticated = false;
      }

      static showDashboard() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('dashboard-container').style.display = 'block';
        
        setTimeout(() => {
          document.getElementById('dashboard-container').classList.add('show');
        }, 10);
        
        this.updateUserInfo();
        DataController.fetchData();
        
        AppState.dataRefreshInterval = setInterval(
          DataController.fetchData, 
          CONFIG.refreshInterval
        );
        AppState.updateCheckInterval = setTimeout(
          DataController.checkForUpdates, 
          CONFIG.updateCheckInterval
        );
      }

      static updateUserInfo() {
        if (!AppState.currentUser) return;
        
        document.getElementById('username-display').textContent = AppState.currentUser.username;
        const avatar = document.getElementById('user-avatar');
        avatar.textContent = AppState.currentUser.username.charAt(0).toUpperCase();
        
        // Цвета аватаров по ролям
        const roleColors = {
          'admin': '#ea4335',
          'manager': '#4285f4',
          'supervisor': '#34a853'
        };
        
        avatar.style.backgroundColor = 
          roleColors[AppState.currentUser.role.toLowerCase()] || '#666';
      }

      // ... (остальные методы UIManager остаются без изменений)
    }

    // Класс для управления аутентификацией
    class AuthController {
      static async handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
          UIManager.showLoginError('Введите логин и пароль');
          return;
        }
        
        // Проверка на блокировку после неудачных попыток
        const now = Date.now();
        if (AppState.loginAttempts >= CONFIG.maxLoginAttempts && 
            now - AppState.lastFailedLogin < CONFIG.loginDelay) {
          const remainingTime = Math.ceil((CONFIG.loginDelay - (now - AppState.lastFailedLogin)) / 1000);
          UIManager.showLoginError(`Попробуйте снова через ${remainingTime} секунд`);
          return;
        }
        
        UIManager.showLoading(true);
        
        try {
          const user = await AuthService.login(username, password);
          AppState.currentUser = user;
          AppState.isAuthenticated = true;
          AppState.loginAttempts = 0;
          UIManager.showDashboard();
        } catch (error) {
          AppState.loginAttempts++;
          AppState.lastFailedLogin = Date.now();
          UIManager.showLoginError(error.message);
          console.error('Ошибка входа:', error);
        } finally {
          UIManager.showLoading(false);
        }
      }

      static handleLogout() {
        if (confirm('Вы уверены, что хотите выйти?')) {
          AuthService.logout();
          AppState.isAuthenticated = false;
          UIManager.showLogin();
        }
      }

      static checkAuth() {
        const user = AuthService.getCurrentUser();
        if (user) {
          AppState.currentUser = user;
          AppState.isAuthenticated = true;
          UIManager.showDashboard();
          return true;
        }
        UIManager.showLogin();
        return false;
      }
    }

    // Класс для управления данными (остаётся без изменений)
    class DataController {
      // ... (ваша текущая реализация DataController)
    }

    // Вспомогательные функции
    function clearIntervals() {
      if (AppState.dataRefreshInterval) clearInterval(AppState.dataRefreshInterval);
      if (AppState.updateCheckInterval) clearTimeout(AppState.updateCheckInterval);
    }

    // Инициализация приложения
    document.addEventListener('DOMContentLoaded', () => {
      UIManager.initEventListeners();
      AuthController.checkAuth();
      
      // Инициализация графика после загрузки
      setTimeout(() => {
        if (document.getElementById('history-chart')) {
          UIManager.updateHistoryChart();
        }
      }, 100);
    });
  </script>
</body>
</html>
