<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>CRM Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
      color: #333;
    }

    select, input[type="date"] {
      font-size: 16px;
      padding: 6px 10px;
      margin: 5px;
    }

    #statusbar {
      margin-top: 10px;
      font-size: 14px;
    }

    #spinner, #lastupdate {
      margin: 5px 0;
    }

    #spinner { color: gray; }
    #lastupdate { color: #28a745; }

    .stage-block {
      flex: 1;
      min-width: 300px;
      border: 2px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      background: #fff;
    }

    .stage-block.blue   { border-color: #007bff; }
    .stage-block.purple { border-color: #6f42c1; }
    .stage-block.orange { border-color: #fd7e14; }
    .stage-block.green  { border-color: #28a745; }
    .stage-block.gray   { border-color: #6c757d; }

    .stage-block h4 { margin-top: 0; }

    #vv_count.loading {
      color: gray;
      font-style: italic;
    }

    .spinner-svg {
      display: inline-block;
      width: 20px;
      height: 20px;
      vertical-align: middle;
      margin-left: 6px;
    }

    .spinner-svg circle {
      fill: none;
      stroke: #999;
      stroke-width: 3;
      stroke-linecap: round;
      animation: rotate 1s linear infinite;
    }

    @keyframes rotate {
      0%   { stroke-dasharray: 1, 150; stroke-dashoffset: 0; }
      50%  { stroke-dasharray: 90, 150; stroke-dashoffset: -35; }
      100% { stroke-dasharray: 90, 150; stroke-dashoffset: -124; }
    }

    @media screen and (max-width: 768px) {
      .stage-block { flex: 1 1 100%; }
      body { margin: 10px; }
      h2, h3 { font-size: 20px; }
      select, input[type="date"] {
        font-size: 15px;
        width: 100%;
        margin: 5px 0;
      }
      #statusbar { font-size: 13px; }
    }
  </style>
</head>
<body>
  <h2>üìä CRM Dashboard</h2>

  <label>–ü–µ—Ä–∏–æ–¥:</label>
  <select id="range">
    <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
    <option value="week">–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</option>
    <option value="month">–ú–µ—Å—è—Ü</option>
    <option value="custom">–í—ã–±—Ä–∞—Ç—å –≤—Ä—É—á–Ω—É—é</option>
  </select>

  <label>–°:</label>
  <input type="date" id="startdate">

  <label>–ü–æ:</label>
  <input type="date" id="enddate">

  <div id="statusbar">
    <div id="spinner">üåÄ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞</div>
    <div id="lastupdate">‚úÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
  </div>

  <div style="display:flex; flex-wrap:wrap; gap:20px; margin-top:20px;">
    <div class="stage-block blue" id="report_ndz"></div>
    <div class="stage-block purple" id="report_ndz2"></div>
    <div class="stage-block orange" id="report_call"></div>
    <div class="stage-block green" id="report_recruiter"></div>
    <div class="stage-block gray" id="report_vv">
      <h4>üì¶ –ë–∞–∑–∞ –í–í</h4>
      <p id="vv_count" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...
        <svg class="spinner-svg" viewBox="0 0 50 50">
          <circle cx="25" cy="25" r="20"></circle>
        </svg>
      </p>
    </div>
  </div>

  <script src="/static/stages.js"></script>
  <script src="/static/daily_status.js"></script>
  <script>
    function loadVVCount() {
      const vvCountEl = document.getElementById("vv_count");
      vvCountEl.innerHTML = `–ó–∞–≥—Ä—É–∑–∫–∞...
        <svg class="spinner-svg" viewBox="0 0 50 50">
          <circle cx="25" cy="25" r="20"></circle>
        </svg>`;
      vvCountEl.classList.add("loading");

      const range = document.getElementById("range").value || "today";
      fetch("/summary_vv?range=" + range)
        .then(r => r.json())
        .then(data => {
          vvCountEl.textContent = data.count !== undefined
            ? `–í—Å–µ–≥–æ –ª–∏–¥–æ–≤: ${data.count}`
            : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
          vvCountEl.classList.remove("loading");
        })
        .catch(() => {
          vvCountEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
          vvCountEl.classList.remove("loading");
        });
    }

    document.getElementById("range").addEventListener("change", loadVVCount);
    window.addEventListener("load", loadVVCount);
  </script>
</body>
</html>

