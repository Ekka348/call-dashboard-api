<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- ... (остальные мета-теги и стили остаются без изменений) ... -->
  <style>
    /* ... (предыдущие стили остаются без изменений) ... */
    
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    #history-chart {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <!-- ... (остальная разметка до dashboard-grid) ... -->

  <div class="dashboard-grid" id="content">
    <!-- ... (предыдущие карточки) ... -->
    
    <!-- Карточка с графиком (добавляем id для canvas) -->
    <div class="card full-width">
      <div class="card-header">
        <span>Динамика лидов за последние 24 часа</span>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="history-chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ... (предыдущий код до функции updateHistoryChart) ...

    // Перемещаем объявление переменной historyChart в начало
    let historyChart = null;

    // Модифицированная функция updateHistoryChart
    function updateHistoryChart() {
      const ctx = document.getElementById('history-chart');
      
      // Проверяем, существует ли элемент
      if (!ctx) {
        console.error('Элемент canvas с id "history-chart" не найден');
        return;
      }
      
      // Получаем контекст только если элемент существует
      const chartCtx = ctx.getContext('2d');
      
      // Цвета для линий графика
      const colors = {
        "На согласовании": getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#4285f4',
        "Перезвонить": getComputedStyle(document.documentElement).getPropertyValue('--warning') || '#fbbc05',
        "Приглашен к рекрутеру": getComputedStyle(document.documentElement).getPropertyValue('--success') || '#34a853'
      };
      
      // Создаем наборы данных для графика
      const datasets = [];
      for (const stageName in historyData.stages) {
        datasets.push({
          label: stageName,
          data: historyData.stages[stageName],
          borderColor: colors[stageName],
          backgroundColor: `${colors[stageName]}20`,
          tension: 0.3,
          fill: false
        });
      }
      
      // Если график уже существует - обновляем его данные
      if (historyChart) {
        historyChart.data.labels = historyData.timestamps;
        historyChart.data.datasets = datasets;
        historyChart.update();
        return;
      }
      
      // Создаем новый график только если есть данные
      if (historyData.timestamps.length > 0) {
        historyChart = new Chart(chartCtx, {
          type: 'line',
          data: {
            labels: historyData.timestamps,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                mode: 'index',
                intersect: false
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Время'
                },
                grid: {
                  display: false
                }
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Количество лидов'
                }
              }
            }
          }
        });
      }
    }

    // В функции updateDashboard изменяем вызов addToHistory
    function updateDashboard(data) {
      if (!data || !data.data) {
        console.error('Получены неверные данные');
        return;
      }
      
      for (const [stageName, stageConfig] of Object.entries(STAGES)) {
        const stageData = data.data[stageName];
        if (stageData) {
          updateStage(stageName, stageConfig, stageData);
        }
      }
      
      // Добавляем текущие данные в историю только после обновления таблиц
      setTimeout(() => {
        addToHistory(data);
      }, 0);
    }

    // В обработчике DOMContentLoaded добавляем проверку
    document.addEventListener('DOMContentLoaded', () => {
      // Проверяем авторизацию при загрузке
      checkAuth();
      
      // ... (остальные обработчики событий) ...
      
      // Инициализируем график только после полной загрузки
      setTimeout(() => {
        if (document.getElementById('history-chart')) {
          updateHistoryChart();
        }
      }, 100);
    });
  </script>
</body>
</html>
