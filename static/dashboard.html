<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CRM Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; background-color: #f4f4f4; color: #333; }
    select, button { font-size: 16px; padding: 6px 10px; margin: 5px; }
    #report, #chart, #chatbox { margin-top: 20px; }
    #report table { border-collapse: collapse; width: 100%; }
    #report th, #report td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    #chart { height: 400px; }
    #chatbox { border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fff; width: 100%; max-width: 600px; }
    #chatlog { height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; margin-bottom: 10px; background: #fefefe; }
    #chatinput { width: 100%; padding: 8px; font-size: 15px; }
  </style>
</head>
<body>
  <h2>üìä CRM Dashboard —Å —Ç–∞–±–ª–∏—Ü–µ–π, –≥—Ä–∞—Ñ–∏–∫–æ–º –∏ —á–∞—Ç–æ–º</h2>

  <label>–°—Ç–∞–¥–∏—è:</label>
  <select id="stage">
    <option>–ù–î–ó</option>
    <option>–ù–î–ó 2</option>
    <option>–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</option>
    <option>–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É</option>
  </select>

  <label>–ü–µ—Ä–∏–æ–¥:</label>
  <select id="range">
    <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
    <option value="week">–ù–µ–¥–µ–ª—è</option>
    <option value="month">–ú–µ—Å—è—Ü</option>
  </select>

  <button onclick="loadStats()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>

  <div id="report"></div>
  <div id="chart"></div>

  <hr>
  <div id="chatbox">
    <h3>üí¨ Chat Assistant</h3>
    <div id="chatlog"></div>
    <input type="text" id="chatinput" placeholder="–ù–∞–ø–∏—à–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–∫–∞–∂–∏ –≥—Ä–∞—Ñ–∏–∫ –∑–∞ –Ω–µ–¥–µ–ª—é" onkeypress="handleChat(event)">
  </div>

  <script>
    async function loadStats() {
      const stage = document.getElementById("stage").value;
      const range = document.getElementById("range").value;
      const res = await fetch(`/stats_data?label=${encodeURIComponent(stage)}&range=${range}`);
      const data = await res.json();
      renderTable(data);
      renderChart(data);
    }

    function renderTable(data) {
      let html = `<h3>üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞–¥–∏–∏ "${data.stage}" –∑–∞ –ø–µ—Ä–∏–æ–¥ "${data.range}"</h3>`;
      html += `<p>–í—Å–µ–≥–æ –ª–∏–¥–æ–≤: ${data.total}</p><table><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–õ–∏–¥–æ–≤</th></tr>`;
      for (let i = 0; i < data.labels.length; i++) {
        html += `<tr><td>${data.labels[i]}</td><td>${data.values[i]}</td></tr>`;
      }
      html += `</table>`;
      document.getElementById("report").innerHTML = html;
    }

    function renderChart(data) {
      const trace = {
        x: data.labels,
        y: data.values,
        type: "bar",
        marker: { color: "#007bff" }
      };
      const layout = {
        title: `üìä –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Äî "${data.stage}" (${data.range})`,
        margin: { t: 40, l: 60, r: 30, b: 100 }
      };
      Plotly.newPlot("chart", [trace], layout);
    }

    function handleChat(e) {
      if (e.key === "Enter") {
        const input = document.getElementById("chatinput").value.trim();
        if (!input) return;
        logChat("üë§ " + input);
        processChat(input);
        document.getElementById("chatinput").value = "";
      }
    }

    function logChat(message) {
      const log = document.getElementById("chatlog");
      log.innerHTML += `<div>${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    async function processChat(message) {
      let stage = "–ù–î–ó", range = "week";

      if (message.includes("–ù–î–ó 2")) stage = "–ù–î–ó 2";
      if (message.includes("–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å")) stage = "–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å";
      if (message.includes("—Ä–µ–∫—Ä—É—Ç–µ—Ä")) stage = "–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É";

      if (message.includes("—Å–µ–≥–æ–¥–Ω—è")) range = "today";
      if (message.includes("–Ω–µ–¥–µ–ª—è")) range = "week";
      if (message.includes("–º–µ—Å—è—Ü")) range = "month";

      const res = await fetch(`/stats_data?label=${encodeURIComponent(stage)}&range=${range}`);
      const data = await res.json();

      logChat(`ü§ñ –ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ —Å—Ç–∞–¥–∏–∏ "${stage}" –∑–∞ –ø–µ—Ä–∏–æ–¥ "${range}": ${data.total} –ª–∏–¥–æ–≤`);
      renderTable(data);
      renderChart(data);
    }
  </script>
</body>
</html>

