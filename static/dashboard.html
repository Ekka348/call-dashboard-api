<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>CRM Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; background: #f4f4f4; color: #333; }
    select, button { font-size: 16px; padding: 6px 10px; margin: 5px; }
    #report, #chart { margin-top: 20px; }
    #report table { border-collapse: collapse; width: 100%; background: #fff; }
    #report th, #report td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    #chart { height: 400px; margin-top: 20px; }
    #timestamp { margin-top: 10px; color: #555; font-size: 14px; }
  </style>
</head>
<body>
  <h2>üìä CRM Dashboard</h2>

  <label>–°—Ç–∞–¥–∏—è:</label>
  <select id="stage">
    <option>–ù–î–ó</option>
    <option>–ù–î–ó 2</option>
    <option>–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</option>
    <option>–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É</option>
  </select>

  <label>–ü–µ—Ä–∏–æ–¥:</label>
  <select id="range">
    <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
    <option value="week">–ù–µ–¥–µ–ª—è</option>
    <option value="month">–ú–µ—Å—è—Ü</option>
  </select>

  <button onclick="loadStats()">üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞–¥–∏—è–º</button>
  <button onclick="loadWeekly()">üìÖ –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞</button>
  <button onclick="toggleAutoRefresh()">üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="autostatus">–í–ö–õ</span></button>

  <div id="timestamp"></div>
  <div id="report"></div>
  <div id="chart"></div>

  <script>
    let autoRefresh = true;
    let refreshInterval;

    function updateTimestamp() {
      const now = new Date();
      const formatted = now.toLocaleTimeString();
      document.getElementById("timestamp").innerText = `üïí –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatted}`;
    }

    async function loadStats() {
      const stage = document.getElementById("stage").value;
      const range = document.getElementById("range").value;
      const res = await fetch(`/stats_data?label=${encodeURIComponent(stage)}&range=${range}`);
      const data = await res.json();
      renderTable(data);
      renderChart(data);
      updateTimestamp();
    }

    async function loadWeekly() {
      const stage = document.getElementById("stage").value;
      const res = await fetch(`/weekly_breakdown?label=${encodeURIComponent(stage)}`);
      const data = await res.json();
      renderWeeklyTable(data);
      renderWeeklyChart(data, stage);
      updateTimestamp();
    }

    function renderTable(data) {
      let html = `<h3>üìã –°—Ç–∞–¥–∏—è: "${data.stage}", –ø–µ—Ä–∏–æ–¥: "${data.range}"</h3>`;
      html += `<p>–í—Å–µ–≥–æ –ª–∏–¥–æ–≤: ${data.total}</p><table><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–õ–∏–¥–æ–≤</th></tr>`;
      for (let i = 0; i < data.labels.length; i++) {
        html += `<tr><td>${data.labels[i]}</td><td>${data.values[i]}</td></tr>`;
      }
      html += `</table>`;
      document.getElementById("report").innerHTML = html;
    }

    function renderChart(data) {
      const trace = {
        x: data.labels,
        y: data.values,
        type: "bar",
        marker: { color: "#007bff" }
      };
      const layout = {
        title: `üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî "${data.stage}" (${data.range})`,
        margin: { t: 40, l: 60, r: 30, b: 100 }
      };
      Plotly.newPlot("chart", [trace], layout);
    }

    function renderWeeklyTable(data) {
      let html = `<h3>üìÖ –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞</h3>`;
      html += `<table><tr><th>–ù–µ–¥–µ–ª—è</th><th>–õ–∏–¥–æ–≤</th></tr>`;
      for (let i = 0; i < data.length; i++) {
        html += `<tr><td>${data[i].week}</td><td>${data[i].count}</td></tr>`;
      }
      html += `</table>`;
      document.getElementById("report").innerHTML = html;
    }

    function renderWeeklyChart(data, stage) {
      const labels = data.map(d => d.week);
      const values = data.map(d => d.count);
      const trace = {
        x: labels,
        y: values,
        type: "scatter",
        mode: "lines+markers",
        marker: { color: "#28a745" }
      };
      const layout = {
        title: `üìà –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º ‚Äî "${stage}"`,
        margin: { t: 40, l: 60, r: 30, b: 100 }
      };
      Plotly.newPlot("chart", [trace], layout);
    }

    function toggleAutoRefresh() {
      autoRefresh = !autoRefresh;
      document.getElementById("autostatus").innerText = autoRefresh ? "–í–ö–õ" : "–í–´–ö–õ";
      if (!autoRefresh) clearInterval(refreshInterval);
      else startAutoRefresh();
    }

    function startAutoRefresh() {
      refreshInterval = setInterval(() => {
        const activeButton = document.activeElement?.innerText;
        if (activeButton?.includes("–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∞—è")) loadWeekly();
        else loadStats();
      }, 120000); // –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
    }

    window.onload = () => {
      loadStats();
      startAutoRefresh();
    };
  </script>
</body>
</html>


