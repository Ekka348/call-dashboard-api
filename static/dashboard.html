<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- ... (остальная часть head без изменений) ... -->
</head>
<body>
  <form class="filter" onsubmit="fetchStats(); return false;">
    <span class="period-label">Период:</span>
    <div class="period-input-group">
      <svg viewBox="0 0 24 24"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1V3a1 1 0 1 1 2 0v1zm12 4H5v14h14V6zm-2 4v2H7v-2h10zm0 4v2H7v-2h10z"/></svg>
      <input type="date" id="startDate" required>
    </div>
    <span class="period-label">—</span>
    <div class="period-input-group">
      <svg viewBox="0 0 24 24"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1V3a1 1 0 1 1 2 0v1zm12 4H5v14h14V6zm-2 4v2H7v-2h10zm0 4v2H7v-2h10z"/></svg>
      <input type="date" id="endDate" required>
    </div>
    <!-- Убрали лишний select и оставили только кастомный dropdown -->
    <div id="operator-filter">
      <div class="dropdown-selected" onclick="toggleDropdown(event)">
        <span id="selected-ops-label">Все операторы</span>
        <span class="arrow">▼</span>
      </div>
      <div class="dropdown-list" id="dropdown-list"></div>
    </div>
    <button type="submit">Показать статистику</button>
  </form>

  <!-- ... (остальная часть HTML без изменений) ... -->

  <script>
    const STAGE_LABELS = ['Перезвонить', 'На согласовании', 'Приглашен к рекрутеру'];
    let userRole = null;
    let operatorList = [];
    let selectedOperators = new Set();

    function toggleDropdown(event) {
      event.stopPropagation();
      const list = document.getElementById('dropdown-list');
      if (list) {
        list.style.display = (list.style.display === 'block') ? 'none' : 'block';
      }
    }
    
    document.addEventListener('click', function(e) {
      const list = document.getElementById('dropdown-list');
      const filter = document.getElementById('operator-filter');
      if (list && list.style.display === 'block' && filter && !filter.contains(e.target)) {
        list.style.display = 'none';
      }
    });

    function updateSelectedLabel() {
      const label = document.getElementById('selected-ops-label');
      if (!label) return;
      
      if (selectedOperators.size === 0 || selectedOperators.size === operatorList.length) {
        label.textContent = 'Все операторы';
      } else {
        const selectedNames = operatorList
          .filter(op => selectedOperators.has(op.id.toString()))
          .map(op => op.name);
        label.textContent = selectedNames.join(', ') || 'Выберите операторов';
      }
    }

    async function loadUserInfoAndOperators() {
      try {
        const user = await fetch('/api/userinfo').then(r => {
          if (!r.ok) throw new Error('Ошибка получения данных пользователя');
          return r.json();
        });
        
        userRole = user.role;
        if (userRole === 'admin') {
          document.getElementById('operator-filter').style.display = 'flex';
          
          const ops = await fetch('/api/operators').then(r => {
            if (!r.ok) throw new Error('Ошибка получения списка операторов');
            return r.json();
          });
          
          operatorList = ops;
          // По умолчанию выбраны все операторы
          selectedOperators = new Set(operatorList.map(o => o.id.toString()));
          renderOperatorDropdown();
          updateSelectedLabel();
        } else {
          document.getElementById('operator-filter').style.display = 'none';
        }
      } catch (e) {
        console.error('Ошибка:', e);
        // Можно добавить уведомление пользователю
      }
    }

    function renderOperatorDropdown() {
      const list = document.getElementById('dropdown-list');
      if (!list) return;
      
      list.innerHTML = '';
      
      // Добавляем чекбокс "Выбрать всех"
      const allChecked = selectedOperators.size === operatorList.length;
      list.innerHTML += `
        <label class="all-ops">
          <input type="checkbox" 
                 onchange="toggleAllOperators(this)" 
                 ${allChecked ? 'checked' : ''}>
          Все операторы
        </label>
      `;
      
      // Добавляем операторов
      operatorList.forEach(op => {
        const isChecked = selectedOperators.has(op.id.toString());
        list.innerHTML += `
          <label>
            <input type="checkbox" 
                   value="${op.id}" 
                   ${isChecked ? 'checked' : ''} 
                   onchange="toggleOperator(this)">
            ${op.name}
          </label>
        `;
      });
    }

    function toggleOperator(checkbox) {
      const operatorId = checkbox.value;
      if (checkbox.checked) {
        selectedOperators.add(operatorId);
      } else {
        selectedOperators.delete(operatorId);
      }
      updateSelectedLabel();
    }

    function toggleAllOperators(checkbox) {
      if (checkbox.checked) {
        operatorList.forEach(op => selectedOperators.add(op.id.toString()));
      } else {
        selectedOperators.clear();
      }
      // Перерисовываем список, чтобы обновить все чекбоксы
      renderOperatorDropdown();
      updateSelectedLabel();
    }

    function getSelectedOperators() {
      if (userRole !== 'admin') return '';
      if (selectedOperators.size === 0 || selectedOperators.size === operatorList.length) return '';
      return Array.from(selectedOperators).join(',');
    }

    function fetchStats() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      if (!start || !end) {
        alert("Пожалуйста, заполните обе даты");
        return;
      }
      
      const operators = getSelectedOperators();
      STAGE_LABELS.forEach(stage => {
        const container = document.getElementById(`table-${stage}`);
        if (!container) return;
        
        container.innerHTML = `
          <div class="mini-loader" id="loader-${stage}" style="display:flex;">
            <div class="mini-spinner"></div>
          </div>
        `;
        
        let url = `/update_stage/${stage}?range=custom:${start}:${end}`;
        if (operators) {
          url += `&operators=${encodeURIComponent(operators)}`;
        }
        
        fetch(url)
          .then(r => {
            if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
            return r.json();
          })
          .then(data => {
            const stageData = data[stage];
            container.innerHTML = '';
            
            if (!stageData.details || stageData.details.length === 0) {
              container.innerHTML = `<p>Нет данных за выбранный период</p>`;
              return;
            }
            
            const table = document.createElement('table');
            table.innerHTML = `
              <thead>
                <tr>
                  <th>Оператор</th>
                  <th>Количество</th>
                </tr>
              </thead>
            `;
            
            const tbody = document.createElement('tbody');
            stageData.details.forEach(item => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${item.operator}</td>
                <td><span class="badge">${item.count}</span></td>
              `;
              tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
          })
          .catch(err => {
            console.error(`Ошибка загрузки данных для "${stage}":`, err);
            container.innerHTML = `
              <p class="error-message">
                ⛔ Ошибка загрузки данных. Пожалуйста, попробуйте позже.
              </p>
            `;
          });
      });
    }

    window.onload = async () => {
      await loadUserInfoAndOperators();
      
      // Устанавливаем даты по умолчанию (сегодня)
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("startDate").value = today;
      document.getElementById("endDate").value = today;
      
      // Загружаем данные сразу после загрузки страницы
      fetchStats();
    };
  </script>
</body>
</html>
