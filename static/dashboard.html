<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>ERS: –î–∞—à–±–æ—Ä–¥ –ª–∏–¥–æ–≤</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      margin: 30px;
    }
    h2 {
      text-align: center;
      margin-bottom: 40px;
    }
    .stage-block {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .stage-block h3 {
      margin-top: 0;
      font-size: 1.3em;
    }
    .refresh-btn {
      margin-top: 5px;
      padding: 6px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .refresh-btn:hover {
      background: #0056b3;
    }
    .stage-table {
      margin-top: 15px;
      transition: opacity 0.3s;
    }
    .stage-table ul {
      padding-left: 18px;
      list-style-type: disc;
    }
    .stage-table li {
      margin-bottom: 4px;
    }
    .error-msg {
      color: crimson;
      font-weight: bold;
    }
    .loading {
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>

  <h2>–î–∞—à–±–æ—Ä–¥ –ø–æ —Å—Ç–∞–¥–∏—è–º</h2>

  <div class="stage-block">
    <h3>–°—Ç–∞–¥–∏—è: –ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</h3>
    <button class="refresh-btn" onclick="updateStage('–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏')">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <div id="table-–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏" class="stage-table loading">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º...</div>
  </div>

  <div class="stage-block">
    <h3>–°—Ç–∞–¥–∏—è: –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</h3>
    <button class="refresh-btn" onclick="updateStage('–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å')">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <div id="table-–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å" class="stage-table loading">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º...</div>
  </div>

  <div class="stage-block">
    <h3>–°—Ç–∞–¥–∏—è: –ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É</h3>
    <button class="refresh-btn" onclick="updateStage('–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É')">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <div id="table-–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É" class="stage-table loading">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º...</div>
  </div>

  <script>
    function updateStage(stageName) {
      const el = document.getElementById("table-" + stageName);
      el.classList.add("loading");
      el.innerHTML = "‚è≥ –û–±–Ω–æ–≤–ª—è–µ–º...";
      el.style.opacity = 0.5;

      fetch("/update_stage/" + encodeURIComponent(stageName))
        .then(res => {
          if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + res.status);
          return res.json();
        })
        .then(data => {
          const name = Object.keys(data)[0];
          const stage = data[name];
          let html = "";

          if (stage.grouped) {
            html = `<p>–í—Å–µ–≥–æ –ª–∏–¥–æ–≤: <b>${stage.count}</b></p>`;
          } else if (!stage.details || stage.details.length === 0) {
            html = `<p class="error-msg">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>`;
          } else {
            html = "<ul>" + stage.details.map(d =>
              `<li><b>${d.operator}</b>: ${d.count}</li>`
            ).join("") + "</ul>";
          }

          el.innerHTML = html;
          el.classList.remove("loading");
          el.style.opacity = 1;
        })
        .catch(err => {
          el.innerHTML = `<p class="error-msg">‚õî –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>`;
          el.classList.remove("loading");
          el.style.opacity = 1;
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞–¥–∏–∏", stageName, err);
        });
    }

    // üöÄ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    ["–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏", "–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å", "–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É"].forEach(updateStage);
  </script>

</body>
</html>

