<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .stage-header { cursor: pointer; }
        .loading { opacity: 0.5; pointer-events: none; }
        .operator-badge { margin-right: 5px; margin-bottom: 5px; }
        .custom-range { max-width: 300px; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .logout-btn { position: absolute; top: 20px; right: 20px; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>Статистика операторов</h2>
                <div class="d-flex align-items-center">
                    <span class="me-2">Пользователь:</span>
                    <strong id="current-user"></strong>
                    <span class="ms-3 me-2">Роль:</span>
                    <strong id="current-role"></strong>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <a href="/logout" class="btn btn-outline-danger logout-btn">Выйти</a>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="input-group mb-3">
                    <label class="input-group-text" for="date-range">Период:</label>
                    <select class="form-select" id="date-range">
                        <option value="today">Сегодня</option>
                        <option value="week">Неделя</option>
                        <option value="month">Месяц</option>
                        <option value="custom">Выбрать даты</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4" id="custom-date-container" style="display: none;">
                <div class="input-group">
                    <input type="text" class="form-control" id="custom-date-range" placeholder="Выберите период">
                    <button class="btn btn-primary" id="apply-custom-date">Применить</button>
                </div>
            </div>
            <div class="col-md-4" id="operator-filter-container">
                <div class="input-group mb-3">
                    <label class="input-group-text" for="operator-select">Оператор:</label>
                    <select class="form-select" id="operator-select">
                        <option value="">Все операторы</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row" id="stages-container">
            <!-- Динамически загружаемые карточки стадий -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация
            let currentOperators = [];
            const dateRange = document.getElementById('date-range');
            const customDateContainer = document.getElementById('custom-date-container');
            const customDateRange = document.getElementById('custom-date-range');
            const applyCustomDate = document.getElementById('apply-custom-date');
            const operatorSelect = document.getElementById('operator-select');
            const stagesContainer = document.getElementById('stages-container');
            const currentUserElement = document.getElementById('current-user');
            const currentRoleElement = document.getElementById('current-role');
            const operatorFilterContainer = document.getElementById('operator-filter-container');

            // Flatpickr для выбора дат
            flatpickr(customDateRange, {
                mode: 'range',
                locale: 'ru',
                dateFormat: 'Y-m-d',
                maxDate: 'today'
            });

            // Загрузка данных пользователя
            fetch('/api/userinfo')
                .then(response => response.json())
                .then(data => {
                    currentUserElement.textContent = data.name;
                    currentRoleElement.textContent = data.role === 'admin' ? 'Администратор' : 'Оператор';
                    
                    // Для админов загружаем список операторов
                    if (data.role === 'admin') {
                        loadOperators();
                    } else {
                        operatorFilterContainer.style.display = 'none';
                    }
                    
                    // Первоначальная загрузка данных
                    loadStages('today');
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных пользователя:', error);
                });

            // Обработчики событий
            dateRange.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customDateContainer.style.display = 'block';
                } else {
                    customDateContainer.style.display = 'none';
                    loadStages(this.value);
                }
            });

            applyCustomDate.addEventListener('click', function() {
                if (customDateRange.value) {
                    const dates = customDateRange.value.split(' to ');
                    const range = `custom:${dates[0]}:${dates[1] || dates[0]}`;
                    loadStages(range);
                }
            });

            operatorSelect.addEventListener('change', function() {
                const range = dateRange.value === 'custom' 
                    ? `custom:${customDateRange.value.split(' to ').join(':')}` 
                    : dateRange.value;
                loadStages(range);
            });

            // Функция загрузки операторов (только для админов)
            function loadOperators() {
                fetch('/api/operators')
                    .then(response => {
                        if (!response.ok) throw new Error('Ошибка загрузки операторов');
                        return response.json();
                    })
                    .then(operators => {
                        currentOperators = operators;
                        const operatorSelect = document.getElementById('operator-select');
                        
                        // Сохраняем текущее выбранное значение
                        const selectedValue = operatorSelect.value;
                        
                        // Очищаем и добавляем только активных операторов
                        operatorSelect.innerHTML = '<option value="">Все операторы</option>';
                        
                        operators.forEach(op => {
                            const option = document.createElement('option');
                            option.value = op.id;
                            option.textContent = op.surname || op.name.split(' ').pop();
                            operatorSelect.appendChild(option);
                        });
                        
                        // Восстанавливаем выбранное значение, если оно есть в новых данных
                        if (selectedValue && operators.some(op => op.id === selectedValue)) {
                            operatorSelect.value = selectedValue;
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки операторов:', error);
                        // Можно показать сообщение об ошибке
                    });
            }

            // Функция загрузки стадий
            function loadStages(range) {
                stagesContainer.classList.add('loading');
                
                const selectedOperator = operatorSelect.value;
                let url = '/api/leads/by-stage?range=' + encodeURIComponent(range);
                
                if (selectedOperator) {
                    url += '&operators=' + selectedOperator;
                }

                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error('Ошибка загрузки данных');
                        return response.json();
                    })
                    .then(data => {
                        renderStages(data.data);
                        stagesContainer.classList.remove('loading');
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки стадий:', error);
                        stagesContainer.classList.remove('loading');
                        // Можно показать сообщение об ошибке
                    });
            }

            // Рендер карточек стадий
            function renderStages(stages) {
                stagesContainer.innerHTML = '';

                for (const [stageName, stageData] of Object.entries(stages)) {
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4';
                    card.innerHTML = `
                        <div class="card">
                            <div class="card-header stage-header d-flex justify-content-between align-items-center" 
                                 data-bs-toggle="collapse" data-bs-target="#collapse-${stageName.replace(/\s+/g, '-')}">
                                <h5 class="mb-0">${stageName}</h5>
                                <span class="badge bg-primary rounded-pill">${stageData.grouped ? stageData.count : stageData.details.reduce((a, b) => a + b.count, 0)}</span>
                            </div>
                            <div class="collapse show" id="collapse-${stageName.replace(/\s+/g, '-')}">
                                <div class="card-body">
                                    ${stageData.grouped ? `
                                        <p class="text-muted">Групповая стадия</p>
                                        <p>Всего: ${stageData.count}</p>
                                    ` : `
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Оператор</th>
                                                        <th class="text-end">Количество</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${stageData.details.map(item => `
                                                        <tr>
                                                            <td>${item.operator.split(' ').pop()}</td>
                                                            <td class="text-end">${item.count}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                    stagesContainer.appendChild(card);
                }
            }
        });
    </script>
</body>
</html>
