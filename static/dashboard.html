<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>CRM Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; background: #f4f4f4; color: #333; }
    select, button, input { font-size: 16px; padding: 6px 10px; margin: 5px; }
    #report, #chart, #chatbox, #historybox { margin-top: 20px; }
    #report table { border-collapse: collapse; width: 100%; background: #fff; }
    #report th, #report td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    #chart { height: 400px; margin-top: 20px; }
    #loading { font-weight: bold; font-size: 16px; margin-top: 10px; color: #555; }
    #spinner { display: none; margin-right: 8px; }
    #chatbox { border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fff; max-width: 600px; }
    #chatlog { height: 180px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; margin-bottom: 10px; background: #fefefe; }
    #chatinput { width: 100%; padding: 8px; font-size: 15px; }
    #chatbuttons button { margin: 4px; padding: 6px 10px; font-size: 14px; }
    #historybox { font-size: 14px; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ddd; display: none; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üìä CRM Dashboard</h2>

  <label>–°—Ç–∞–¥–∏—è:</label>
  <select id="stage">
    <option>–ù–î–ó</option>
    <option>–ù–î–ó 2</option>
    <option>–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</option>
    <option>–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É</option>
  </select>

  <label>–ü–µ—Ä–∏–æ–¥:</label>
  <select id="range">
    <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
    <option value="week">–ù–µ–¥–µ–ª—è</option>
    <option value="month">–ú–µ—Å—è—Ü</option>
  </select>

  <button onclick="loadStats()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button onclick="toggleReport()">üìã –°–∫—Ä—ã—Ç—å/–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
  <button onclick="toggleChart()">üìâ –°–∫—Ä—ã—Ç—å/–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>

  <div id="loading"><span id="spinner">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
  <div id="report"></div>
  <div id="chart"></div>

<hr>
  <div id="chatbox">
    <h3>üí¨ Chat Assistant</h3>

    <div id="chatbuttons">
      <button onclick="presetChat('–ù–î–ó –Ω–µ–¥–µ–ª—è')">–ù–î–ó –Ω–µ–¥–µ–ª—è</button>
      <button onclick="presetChat('–ù–î–ó 2 –º–µ—Å—è—Ü')">–ù–î–ó 2 –º–µ—Å—è—Ü</button>
      <button onclick="presetChat('–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è')">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è</button>
      <button onclick="presetChat('—Ä–µ–∫—Ä—É—Ç–µ—Ä –Ω–µ–¥–µ–ª—è')">–†–µ–∫—Ä—É—Ç–µ—Ä –Ω–µ–¥–µ–ª—è</button>
    </div>

    <div id="chatlog"></div>
    <input type="text" id="chatinput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ù–î–ó –Ω–µ–¥–µ–ª—è'" title="–ü–æ–ø—Ä–æ–±—É–π: '–ù–î–ó –Ω–µ–¥–µ–ª—è', '–ù–î–ó 2 –º–µ—Å—è—Ü', '–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è'" onkeypress="handleChat(event)" />
    <button onclick="toggleHistory()">üìú –°–∫—Ä—ã—Ç—å/–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <div id="historybox"></div>
  </div>

  <script>
    let chatHistory = [];

    async function loadStats() {
      const stage = document.getElementById("stage").value;
      const range = document.getElementById("range").value;
      showLoading(true, "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞...");
      const res = await fetch(`/stats_data?label=${encodeURIComponent(stage)}&range=${range}`);
      const data = await res.json();
      renderTable(data);
      renderChart(data);
      announceTopUser(data);
      showLoading(false);
    }

    function showLoading(show, text = "") {
      const spinner = document.getElementById("spinner");
      spinner.style.display = show ? "inline" : "none";
      spinner.innerText = text;
    }

    function renderTable(data) {
      let html = `<h3>üìã –°—Ç–∞–¥–∏—è: "${data.stage}", –ø–µ—Ä–∏–æ–¥: "${data.range}"</h3>`;
      html += `<p>–í—Å–µ–≥–æ –ª–∏–¥–æ–≤: ${data.total}</p><table><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–õ–∏–¥–æ–≤</th></tr>`;
      for (let i = 0; i < data.labels.length; i++) {
        html += `<tr><td>${data.labels[i]}</td><td>${data.values[i]}</td></tr>`;
      }
      html += `</table>`;
      document.getElementById("report").innerHTML = html;
    }

    function renderChart(data) {
      const trace = {
        x: data.labels,
        y: data.values,
        type: "bar",
        marker: { color: "#007bff" }
      };
      const layout = {
        title: `üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî "${data.stage}" (${data.range})`,
        margin: { t: 40, l: 60, r: 30, b: 100 }
      };
      Plotly.newPlot("chart", [trace], layout);
    }

    function announceTopUser(data) {
      const maxIndex = data.values.indexOf(Math.max(...data.values));
      const topUser = data.labels[maxIndex];
      logChat(`üèÜ –°–∞–º—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: ${topUser} (${data.values[maxIndex]} –ª–∏–¥–æ–≤)`);
    }

    function handleChat(e) {
      if (e.key === "Enter") {
        const input = document.getElementById("chatinput").value.trim();
        if (!input) return;
        logChat("üë§ " + input);
        processChat(input);
        document.getElementById("chatinput").value = "";
      }
    }

    function logChat(message) {
      chatHistory.push(message);
      const log = document.getElementById("chatlog");
      log.innerHTML += `<div>${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    function toggleHistory() {
      const box = document.getElementById("historybox");
      box.style.display = box.style.display === "none" || !box.style.display ? "block" : "none";
      if (box.style.display === "block") {
        box.innerHTML = "<h4>üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:</h4>" + chatHistory.map(m => `<div>${m}</div>`).join("");
      }
    }

    function toggleChart() {
      const chart = document.getElementById("chart");
      chart.style.display = chart.style.display === "none" ? "block" : "none";
    }

    function toggleReport() {
      const report = document.getElementById("report");
      report.style.display = report.style.display === "none" ? "block" : "none";
    }

    async function processChat(message) {
      let stage = "–ù–î–ó", range = "week";
      if (message.includes("–ù–î–ó 2")) stage = "–ù–î–ó 2";
      if (message.includes("–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å")) stage = "–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å";
      if (message.includes("—Ä–µ–∫—Ä—É—Ç–µ—Ä")) stage = "–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É";
      if (message.includes("—Å–µ–≥–æ–¥–Ω—è")) range = "today";
      if (message.includes("–Ω–µ–¥–µ–ª—è")) range = "week";
      if (message.includes("–º–µ—Å—è—Ü")) range = "month";

      showLoading(true, "üí¨ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å...");
      const res = await fetch(`/stats_data?label=${encodeURIComponent(stage)}&range=${range}`);
      const data = await res.json();
      logChat(`ü§ñ ${data.stage}, ${data.range}: ${data.total} –ª–∏–¥–æ–≤`);
      renderTable(data);
      renderChart(data);
      announceTopUser(data);
      showLoading(false);
    }

    function presetChat(text) {
      document.getElementById("chatinput").value = text;
      handleChat({ key: "Enter" });
    }
  </script>
</body>
</html>


