<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Real-Time Leads Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #ccc;
    }
    .indicator.active {
      background-color: #4CAF50;
    }
    .last-update {
      font-size: 0.9em;
      color: #666;
    }
    .info-box {
      background-color: #e8f4ff;
      padding: 15px;
      border: 1px solid #b3d8ff;
      margin-bottom: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stage-columns {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    .stage-table {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stage-table h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8f8f8;
    }
    tr.updated {
      background-color: #f8fff0;
      transition: background-color 1.5s;
    }
    .count-badge {
      background-color: #4CAF50;
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 0.8em;
      margin-left: 5px;
    }
    .operators-online {
      background-color: #e1f5fe;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="dashboard-header">
    <h1>üìä Real-Time Leads Dashboard</h1>
    <div class="status-indicator">
      <div class="indicator" id="connection-status"></div>
      <span id="status-text">Connecting...</span>
      <span class="last-update" id="last-update"></span>
    </div>
  </div>

  <div class="operators-online">
    üü¢ –û–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–∞ –ª–∏–Ω–∏–∏: <strong id="online-count">0</strong>
    <div id="operators-list"></div>
  </div>

  <div class="info-box" id="stats">
    <h3>–ò–Ω—Ñ–æ-—Å—Ç–∞–¥–∏–∏</h3>
    <div id="info-stages"></div>
  </div>

  <div class="stage-columns" id="content">
    <div class="stage-table"><h2>–ù–î–ó</h2><div class="table-content"></div></div>
    <div class="stage-table"><h2>–ù–î–ó 2</h2><div class="table-content"></div></div>
    <div class="stage-table"><h2>–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</h2><div class="table-content"></div></div>
    <div class="stage-table"><h2>–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É</h2><div class="table-content"></div></div>
  </div>

  <script>
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    const socket = io();
    const stagesOrder = ["–ù–î–ó", "–ù–î–ó 2", "–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å", "–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É"];
    const infoStages = ["NEW", "OLD", "–ë–∞–∑–∞ –í–í"];

    // –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const connectionStatus = document.getElementById('connection-status');
    const statusText = document.getElementById('status-text');
    const lastUpdate = document.getElementById('last-update');
    const onlineCount = document.getElementById('online-count');
    const operatorsList = document.getElementById('operators-list');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    socket.on('connect', () => {
      console.log('Connected to WebSocket');
      connectionStatus.classList.add('active');
      statusText.textContent = 'Connected';
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from WebSocket');
      connectionStatus.classList.remove('active');
      statusText.textContent = 'Disconnected';
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    socket.on('update', (data) => {
      console.log('Received update', data);
      updateDashboard(data);
      lastUpdate.textContent = new Date().toLocaleTimeString();
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞
    function updateDashboard(data) {
      if (!data || !data.data) return;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ-—Å—Ç–∞–¥–∏–∏
      updateInfoStages(data);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –ø–æ —Å—Ç–∞–¥–∏—è–º
      stagesOrder.forEach(stage => {
        updateStageTable(stage, data.data[stage]);
      });
    }

    function updateInfoStages(data) {
      const container = document.getElementById('info-stages');
      container.innerHTML = '';
      
      infoStages.forEach(stage => {
        const stageData = data.data[stage];
        if (!stageData) return;
        
        const div = document.createElement('div');
        div.innerHTML = `<strong>${stage}:</strong> <span class="count-badge">${stageData.count}</span>`;
        container.appendChild(div);
      });
    }

    function updateStageTable(stage, stageData) {
      const tableDiv = document.querySelector(`.stage-table h2:contains("${stage}")`).parentNode.querySelector('.table-content');
      
      if (!stageData || !stageData.details || stageData.details.length === 0) {
        tableDiv.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
      }

      let html = `<table>
        <thead>
          <tr><th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th></tr>
        </thead>
        <tbody>`;

      stageData.details.forEach(row => {
        html += `<tr>
          <td>${row.operator}</td>
          <td>${row.count}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      tableDiv.innerHTML = html;

      // –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      const rows = tableDiv.querySelectorAll('tr');
      rows.forEach(row => {
        row.classList.add('updated');
        setTimeout(() => row.classList.remove('updated'), 1500);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      fetch('/api/leads/by-stage')
        .then(response => response.json())
        .then(data => updateDashboard(data))
        .catch(error => console.error('Error fetching initial data:', error));
    });
  </script>
</body>
</html>
