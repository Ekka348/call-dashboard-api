<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>CRM Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; background: #f4f4f4; color: #333; }
    select, button, input { font-size: 16px; padding: 6px 10px; margin: 5px; }
    #report, #chart, #chatbox, #historybox { margin-top: 20px; }
    #report table { border-collapse: collapse; width: 100%; background: #fff; }
    #report th, #report td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    #chart { height: 400px; margin-top: 20px; }
    #loading { font-weight: bold; font-size: 16px; margin-top: 10px; color: #555; }
    #spinner { display: none; margin-right: 8px; }
    #chatbox { border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fff; max-width: 700px; }
    #chatlog { height: 180px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; margin-bottom: 10px; background: #fefefe; }
    #chatinput { width: 100%; padding: 8px; font-size: 15px; }
    #chatbuttons button { margin: 4px; padding: 6px 10px; font-size: 14px; }
    #historybox { font-size: 14px; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ddd; display: none; margin-top: 10px; }
    #suggestions ul { padding-left: 18px; }
    #suggestions li { margin-bottom: 4px; }
  </style>
</head>
<body>
  <h2>üìä CRM Dashboard</h2>

  <label>–°—Ç–∞–¥–∏—è:</label>
  <select id="stage">
    <option>–ù–î–ó</option>
    <option>–ù–î–ó 2</option>
    <option>–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</option>
    <option>–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫ —Ä–µ–∫—Ä—É—Ç–µ—Ä—É</option>
  </select>

  <label>–ü–µ—Ä–∏–æ–¥:</label>
  <select id="range">
    <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
    <option value="week">–ù–µ–¥–µ–ª—è</option>
    <option value="month">–ú–µ—Å—è—Ü</option>
  </select>

  <button onclick="loadStats()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button onclick="toggleReport()">üìã –°–∫—Ä—ã—Ç—å/–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
  <button onclick="toggleChart()">üìâ –°–∫—Ä—ã—Ç—å/–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>

  <div id="loading"><span id="spinner">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
  <div id="report"></div>
  <div id="chart"></div>

  <hr>
  <div id="chatbox">
    <h3>üí¨ Chat Assistant</h3>

    <div id="chatbuttons">
      <button onclick="presetChat('–ù–î–ó –Ω–µ–¥–µ–ª—è')">–ù–î–ó –Ω–µ–¥–µ–ª—è</button>
      <button onclick="presetChat('–ù–î–ó 2 –º–µ—Å—è—Ü')">–ù–î–ó 2 –º–µ—Å—è—Ü</button>
      <button onclick="presetChat('–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è')">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è</button>
      <button onclick="presetChat('—Ä–µ–∫—Ä—É—Ç–µ—Ä –Ω–µ–¥–µ–ª—è')">–†–µ–∫—Ä—É—Ç–µ—Ä –Ω–µ–¥–µ–ª—è</button>
      <button onclick="showSuggestions()">‚ùì –ü–æ–¥—Å–∫–∞–∑–∫–∏</button>
    </div>

    <div id="chatcontrols">
      <label for="userselect">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
      <select id="userselect">
        <option value="">‚Äî –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ ‚Äî</option>
      </select>
    </div>

    <input type="text" id="chatinput" list="userlist" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ù–î–ó –Ω–µ–¥–µ–ª—è –ø–æ –ê–ª–∏—è –ê—Ö–º–∞—Ç—à–∏–Ω–∞'" onkeypress="handleChat(event)" />
    <datalist id="userlist"></datalist>

    <button onclick="toggleHistory()">üìú –°–∫—Ä—ã—Ç—å/–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <div id="historybox"></div>
  </div>

  <script>
    function toggleReport() {
      const r = document.getElementById("report");
      r.style.display = r.style.display === "none" ? "block" : "none";
    }

    function toggleChart() {
      const c = document.getElementById("chart");
      c.style.display = c.style.display === "none" ? "block" : "none";
    }

    function toggleHistory() {
      const h = document.getElementById("historybox");
      h.style.display = h.style.display === "none" ? "block" : "none";
    }

    async function loadStats() {
      const stage = document.getElementById("stage").value;
      const range = document.getElementById("range").value;
      const spinner = document.getElementById("spinner");
      spinner.style.display = "inline";
      spinner.innerText = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
      const res = await fetch(`/stats_data?label=${encodeURIComponent(stage)}&range=${range}`);
      const data = await res.json();
      spinner.style.display = "none";
      renderTable(data);
      renderChart(data);
    }

    function renderTable(data) {
      let html = `<h3>üìã –°—Ç–∞–¥–∏—è: "${data.stage}", –ø–µ—Ä–∏–æ–¥: "${data.range}"</h3>`;
      html += `<p>–í—Å–µ–≥–æ –ª–∏–¥–æ–≤: ${data.total}</p><table><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–õ–∏–¥–æ–≤</th></tr>`;
      for (let i = 0; i < data.labels.length; i++) {
        html += `<tr><td>${data.labels[i]}</td><td>${data.values[i]}</td></tr>`;
      }
      html += `</table>`;
      document.getElementById("report").innerHTML = html;
    }

    function renderChart(data) {
      const trace = {
        x: data.labels,
        y: data.values,
        type: "bar",
        marker: { color: "#007bff" }
      };
      const layout = {
        title: `üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî "${data.stage}" (${data.range})`,
        margin: { t: 40, l: 60, r: 30, b: 100 }
      };
      Plotly.newPlot("chart", [trace], layout);
    }
  </script>

  <script src="/static/chat.js"></script>
</body>
</html>

